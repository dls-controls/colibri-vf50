.. _upgrading:

Upgrading
=========

For upgrading the necessary upgrade files must be present on a reachable tftp
server.  Upgrading can be performed from any system with an appropriate network
connection, and upgrading is extremely quick (once the tftp download is complete
the upgrade process and reboot takes a few seconds).

The default upgrade will repace the rootfs and the device tree, but leaving the
state file system alone.  Optionally the state file system can be restored to
its default state, but in this case the network will have to be reconfigured
through the serial console.


Preparation
-----------

For an upgrade the following preparatory steps must be taken.

1.  Identify a reachable tftp server.  The default configuration, stored in
    ``/etc/upgrade.config`` (a link to ``/var/state/etc/upgrade.config``) and
    defined in ``rootfs/upgrade/upgrade.config``, points to
    ``cs03r-cs-vserv-36``.  This server provides a tftp server serving files
    from ``/dls_sw/work/tftpboot/dev``.

2.  Copy the appropriate files with the correct naming convention to the tftp
    server.  The default configuration expects to find the files under
    ``/colibri-vf50/`` on the tftp server.

The make target ``make upgrade`` copies the appropriate files to the directory
specified by ``UPGRADE_ROOT`` and prefixes each file with the git version tag.
This is the correct naming convention to use for upgrades.


Running the Upgrade
-------------------

To run the upgrade connect to the system to be upgraded and run the command::

    upgrade-rootfs -rC $version

where *$version* should be the git version tag generated by ``make upgrade``.
The files will be checked by downloading them from the server (this can be
overridden with a ``-f`` flag) and then the system will reboot and perform the
upgrade.  It should be possible to reconnect within a few seconds.


Upgrade Command
---------------

The upgrade tool is installed as part of the rootfs and is documented below.

..  program:: upgrade-rootfs
..  option:: upgrade-rootfs [options] version

    ..  option:: version

        This mandatory argument specifies the version of the upgrade to be
        installed.

    ..  option:: -d directory

        This identifies the path on the tftp server where the upgrade files are
        stored.  The default path is ``/colibri-vf50``.

    ..  option:: -S server

        This identifies the tftp server to use.  The default server is
        ``cs03r-cs-vserv-36``.

    ..  option:: -p

        If this flag is set then the persistent ``state`` filesystem will be
        replaced.  This will cause the network configuration to be reset, so it
        will be necessary to run :program:`configure-network` on the serial
        console after upgrading if this is specified.

    ..  option:: -f

        By default the upgrade files will be loaded from the tftp server to
        validate the upgrade options.  For a quicker upgrade this flag can be
        set to bypass this step.  Note however, if the files cannot be found
        then the upgrade may fail or be incomplete, and it may be necessary to
        rescue the system using the development board.

    ..  option:: -r

        If this option is set together with :option:`-C` then the system will
        reboot and perform the upgrade immediately.  Without this option the
        upgrade will not be applied until the next system reboot.

    ..  option:: -C

        This option must be set to actually perform the upgrade.  If this is not
        set then the files will be checked (unless :option:`-f` is set) but no
        other action is taken.


Configuration Files
-------------------

The following configurations manage the building and operation of the upgrade
tool.

``/etc/upgrade.config`` on target system
    This file on the target system, actually a soft link to
    ``/var/state/etc/upgrade.config``, contains the following two keys:

    =================== ========================================================
    Key                 Description
    =================== ========================================================
    ``TFTP_SERVER``     Default value for :option:`-S`, specifies tftp server.
    ``TFTP_DIR``        Default value for :option:`-d`, specifies source
                        directory on tftp server
    =================== ========================================================

    This file is maintained in ``rootfs/upgrade/upgrade.config``.

``CONFIG``
    The ``UPGRADE_ROOT`` key in this file is used by the ``make upgrade`` target
    to identify a directory where the necessary upgrade files are installed.


Upgrade Files
-------------

The following files must be served by the tftp server from the configured source
directory for a successful upgrade.  All files must be named with the build
version as a prefix; this is automatically generated by ``make upgrade``.

=============================== ================================================
File                            Description
=============================== ================================================
``device-tree.dtb``             Device tree
``rootfs.img``                  Root file system image
``state.img``                   State file system image (only needed if
                                :option:`-f` selected).
``upgrade-script.image``        U-Boot upgrade script.
=============================== ================================================
